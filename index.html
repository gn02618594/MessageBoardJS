<!DOCTYPE html>

<html>

<head>
	<style>
	</style>
</head>

<body>
	<div>
		<label>搜尋留言:</label>
		<input type="text" id="searchtext">
		<input type="button" id="searchbtn" value="搜尋">
	</div>
	<h1>留言板</h1>
	<div id="newmessagepanel">
		<p>新增留言</p>
		<input type="text" id="newmsg" size="40">
		<input type="button" id="btnsave" value="儲存">
	</div>
	<label id="warningmessage" style="color: red;"></label>
	<div>
		<p>顯示留言</p>
		<div id="msg_c">
		</div>
	</div>
</body>
<script>
	const messageList = [];
	let messageDetailIndex = 0;
	let test = null;
	let oldvalue = null;
	let oMsg = null;
	let oBtn = null;
	let oMsg_c = null;
	let sVal = null;
	let warnmessage = null;
	function save() {
		oMsg = document.querySelector("#newmsg");
		oBtn = document.querySelector("#btnsave");
		oMsg_c = document.querySelector("#msg_c");
		sVal = oMsg.value;
		warnmessage = document.querySelector("#warningmessage");
		if (sVal == "") {
			warnmessage.innerText = "請輸入內容";
			return;
		}
		warnmessage.textContent = "";
		arraychane();
		removedom();
		messageDetailIndex++;
		oMsg.value = "";
	}
	function arraychane() {
		const messageInfo = {
			no: messageDetailIndex,
			name: "test",
			Message: sVal,
			MessageId: "Message" + messageDetailIndex,
			Deleteid: "Delete" + messageDetailIndex,
			Editid: "Edit" + messageDetailIndex
		}
		messageList.push(messageInfo);
	}
	function removedom() {
		while (oMsg_c.firstChild) {
			oMsg_c.removeChild(oMsg_c.firstChild);
		}
		domchange();
	}
	function domchange() {
		messageList.forEach((item) => {
			const oUl = document.createElement("div");
			oUl.id = item.MessageId;
			oMsg_c.appendChild(oUl);
			const dBtnDelete = document.createElement('button');
			dBtnDelete.textContent = '刪除';
			dBtnDelete.id = item.Deleteid;
			const dBtnEdit = document.createElement('button');
			dBtnEdit.textContent = '編輯';
			dBtnEdit.id = item.Editid;
			dBtnEdit.addEventListener('click', () => {
				const messagepanel = document.querySelector("#newmessagepanel");
				while (messagepanel.firstChild) {
					messagepanel.removeChild(messagepanel.firstChild);
				}
				const editmsgp = document.createElement("p");
				editmsgp.textContent = "編輯留言";
				const editmsgtext = document.createElement("input");
				editmsgtext.type = "text";
				editmsgtext.size = "40";
				editmsgtext.id = "texteditmsg";
				editmsgtext.value=dBtnEdit.parentNode.querySelector("a").text;
				const editcancelbutton = document.createElement("button");
				editcancelbutton.textContent = "取消編輯";
				editcancelbutton.id = "btneditcancel";
				editcancelbutton.addEventListener('click', () => {
					while (messagepanel.firstChild) {
						messagepanel.removeChild(messagepanel.firstChild);
					}
					const newmsgp = document.createElement("p");
					newmsgp.textContent = "新增留言";
					const newmsgtext = document.createElement("input");
					newmsgtext.type = "text";
					newmsgtext.size = "40";
					newmsgtext.id = "newmsg";
					const newmsgbtn = document.createElement("button");
					newmsgbtn.textContent = "儲存";
					newmsgbtn.id = "btnsave";
					messagepanel.appendChild(newmsgp);
					messagepanel.appendChild(newmsgtext);
					messagepanel.appendChild(newmsgbtn);
				})
				const editsavebutton = document.createElement("button");
				editsavebutton.textContent = "儲存";
				editsavebutton.id = "btnsave";
				messagepanel.appendChild(editmsgp);
				messagepanel.appendChild(editmsgtext);
				messagepanel.appendChild(editcancelbutton);
				messagepanel.appendChild(editsavebutton);
				/*test = messageList.filter(tests => tests.no == dBtnEdit.id.substr(4))
				removedom(oMsg_c);*/
			})
			dBtnDelete.addEventListener('click', () => {
				messageList.splice(messageList[dBtnDelete.id]);
				removedom();
			})
			const content = document.createElement('a');
			content.textContent = item.Message;
			oUl.appendChild(content);
			oUl.appendChild(dBtnDelete);
			oUl.appendChild(dBtnEdit);

		});
	}
	function savetest() {
		if (test != null) {
			editmessage();
		} else {
			newmessage();
		}
	}
	function editmessage() {
		test[0].message = sVal;
		oldvalue.innerText = sVal;
		oMsg.value = '';
		test = null;
		oldvalue = null;
	}
	function newmessage() {
		const oMsg = document.querySelector("#newmsg");
		const oBtn = document.querySelector("#btnsave");
		const oMsg_c = document.querySelector("#msg_c");
		const oUl = document.createElement("div");
		oUl.id = "Message" + messageDetailIndex;
		if (messageList.length >= 5) {
			oUl.style.display = 'none';
		}
		oMsg_c.appendChild(oUl);
		const sVal = oMsg.value;
		const dBtnDelete = document.createElement('button');
		dBtnDelete.textContent = '刪除';
		dBtnDelete.id = "Delete" + messageDetailIndex;
		const dBtnEdit = document.createElement('button');
		dBtnEdit.textContent = '編輯';
		dBtnEdit.id = "Edit" + messageDetailIndex;
		dBtnEdit.addEventListener('click', () => {
			oldvalue = dBtnEdit.parentNode.querySelector("a");
			oMsg.value = oldvalue.innerText;
			test = messageList.filter(tests => tests.no == dBtnEdit.id.substr(4))
		})
		messageDetailIndex++;
		dBtnDelete.addEventListener('click', () => {
			const dBtnParent = dBtnDelete.parentNode;
			messageList.splice(dBtnDelete.id.substr(6), 1);
			dBtnParent.remove();
		})
		const content = document.createElement('a');
		content.textContent = sVal;
		oUl.appendChild(content);
		oUl.appendChild(dBtnDelete);
		oUl.appendChild(dBtnEdit);
		oMsg.value = '';
	}
	function clearmessage() {
		test = null;
		oldvalue = null;
		savetest();
	}
	function searchmessage() {
		const searchtext = document.querySelector("#searchtext");
		var isfound = 0;
		if (window.find && window.getSelection) {
			document.designMode = "on";
			var sel = window.getSelection();
			sel.collapseToEnd();
			isfound = 0;
			while (window.find(searchtext.value)) {
				document.execCommand("HiliteColor", false, "aquamarine");
				sel.collapseToEnd();
				isfound = 1;
			}
			if (isfound == 0) {
				alert('cant find');
			}
			document.designMode = "off";
		}
	}
	document.querySelector("#btnsave").addEventListener('click', save);
	/*document.querySelector("#clearmessage").addEventListener('click', clearmessage);*/
	document.querySelector("#searchbtn").addEventListener('click', searchmessage);
	debugger;		
</script>

</html>